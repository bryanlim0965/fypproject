<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Game Store | Cart</title>

  <!-- Fonts + Icons -->
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet"/>
  <link href="https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css" rel="stylesheet"/>

  <!-- Styles -->
  <link rel="stylesheet" href="landing.css" />

  <style>
    /* === User menu === */
    .user-menu{ position:relative; display:none; }
    .user-btn{
      display:inline-flex; align-items:center; justify-content:center;
      width:44px; height:44px; border-radius:999px;
      background:#1a1a1a; border:1px solid #262626; color:#00ff00;
      font-size:1.4rem; cursor:pointer; transition:background .15s ease;
    }
    .user-btn:hover{ background:#222; }
    .user-card{
      position:absolute; top:calc(100% + 10px); right:0; min-width:280px;
      background:#111; border:1px solid #222; border-radius:16px;
      box-shadow:0 18px 40px rgba(0,0,0,.5); padding:12px; display:none; z-index:4000;
    }
    .user-menu.open .user-card{ display:block; }
    .uc-header{ display:flex; align-items:center; gap:12px; padding:12px; border-radius:12px; background:#151515; border:1px solid #222; margin-bottom:10px;}
    .uc-avatar{ width:42px; height:42px; border-radius:50%; display:flex; align-items:center; justify-content:center; background:#00ff00; color:#111; font-weight:800;}
    .uc-ident{ line-height:1.2; }
    .uc-name{ font-weight:800; color:#fff; }
    .uc-points{ font-size:.85rem; color:#bdbdbd; }
    .uc-items{ padding:6px 0; }
    .uc-item{ width:100%; display:flex; align-items:center; gap:10px; padding:10px 12px; color:#eaeaea; background:transparent; border:none; text-decoration:none; border-radius:10px; cursor:pointer; font-weight:700; transition:background .15s ease, color .15s ease, transform .05s ease; }
    .uc-item i{ font-size:1.1rem; }
    .uc-item:hover{ background:#1b1b1d; color:#fff; }
    .uc-logout{ width:100%; text-align:left; margin-top:6px; color:#ff8080; }
    .uc-logout:hover{ background:#1b1b1d; color:#ffb3b3; }
  </style>

  <style>
    /* === Cart Page Redesign === */
    body {
      background-color: #0b0b0b;
      color: #fff;
      font-family: 'Poppins', sans-serif;
    }

    .cart-page {
      max-width: 1000px;
      margin: 60px auto;
      background: #111;
      border-radius: 16px;
      padding: 2rem;
      box-shadow: 0 0 25px rgba(0, 255, 100, 0.05);
    }

    .cart-page h2 {
      font-size: 2rem;
      margin-bottom: 2rem;
      color: #00ff80;
      text-align: center;
      font-weight: 600;
    }

    /* Header Row */
    .cart-header {
      display: grid;
      grid-template-columns: 100px 2fr 1fr 1fr 1fr 50px;
      text-align: center;
      font-weight: 600;
      color: #ccc;
      margin-bottom: 1rem;
      border-bottom: 1px solid #222;
      padding-bottom: .5rem;
    }

    .cart-container {
      display: flex;
      flex-direction: column;
      gap: 1rem;
    }

    /* === Cart Item Row === */
    .cart-item {
      display: grid;
      grid-template-columns: 100px 2fr 1fr 1fr 1fr 50px;
      align-items: center;
      background: #1a1a1a;
      border: 1px solid #222;
      border-radius: 12px;
      padding: 1rem;
      transition: transform 0.2s ease, box-shadow 0.2s ease;
    }

    .cart-item:hover {
      transform: translateY(-2px);
      box-shadow: 0 0 15px rgba(0, 255, 128, 0.1);
    }

    .thumb img {
      width: 80px;
      height: 80px;
      border-radius: 8px;
      object-fit: cover;
    }

    .item-name {
      font-weight: 600;
      color: #fff;
      text-align: left;
      font-size: 1rem;
    }

    .item-qty {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: .5rem;
    }

    .qty-btn {
      width: 28px;
      height: 28px;
      background: #00ff80;
      border: none;
      border-radius: 6px;
      color: #000;
      font-weight: bold;
      cursor: pointer;
      font-size: 1rem;
      transition: background 0.2s ease, transform 0.1s ease;
    }

    .qty-btn:hover {
      background: #00e070;
      transform: scale(1.1);
    }

    .qty {
      color: #fff;
      min-width: 24px;
      text-align: center;
      font-weight: 600;
    }

    .item-price, .item-total {
      text-align: center;
      color: #00ff80;
      font-weight: 600;
    }

    .remove-btn {
      background: transparent;
      border: none;
      color: #ff4d4d;
      font-size: 1.5rem;
      cursor: pointer;
      transition: transform 0.2s ease, color 0.2s ease;
    }

    .remove-btn:hover {
      transform: scale(1.2);
      color: #ff6b6b;
    }

    .cart-summary {
      margin-top: 2rem;
      text-align: right;
      font-size: 1.2rem;
      border-top: 1px solid #222;
      padding-top: 1rem;
    }

    .cart-summary p {
      margin-bottom: 1rem;
    }

    .checkout-btn {
      text-decoration: none;
      background: #00ff80;
      border: none;
      color: #111;
      font-weight: bold;
      padding: 0.8rem 1.8rem;
      border-radius: 10px;
      cursor: pointer;
      font-size: 1rem;
      transition: background 0.2s ease;
    }

    .checkout-btn:hover {
      background: #00e070;
    }

    @media (max-width: 768px) {
      .cart-header {
        display: none;
      }

      .cart-item {
        grid-template-columns: 80px 1fr;
        grid-template-rows: auto auto auto;
        gap: .5rem;
        text-align: left;
      }

      .item-name, .item-qty, .item-price, .item-total {
        text-align: left;
      }

      .remove-btn {
        justify-self: end;
      }
    }
  </style>
</head>

<body>

  <!-- ===== Top Header / Nav ===== -->
  <header class="topbar">
    <div class="topbar-row">
      <a href="landing.html" class="brand"><img src="Images/logo.png" alt="Brand Logo"></a>

      <form class="search" action="#" method="get">
        <input type="text" name="q" placeholder="Search" aria-label="Search games, consoles, accessories" />
        <button type="submit" aria-label="Search"><i class='bx bx-search'></i></button>
      </form>

      <div class="actions">
        <a href="#" class="redeem"><i class='bx bxs-hot'></i> <span>REDEEM</span></a>

        <!-- Login pill -->
        <a href="login.html" id="loginBtn" class="icon-btn" aria-label="Login">
          <i class='bx bx-user'></i><span class="label">Login</span>
        </a>

        <!-- User icon + dropdown -->
        <div class="user-menu" id="userMenu">
          <button class="user-btn" id="userBtn" aria-expanded="false" aria-haspopup="true">
            <i class='bx bx-user-circle'></i>
          </button>

          <div class="user-dropdown user-card" id="userDropdown" role="menu">
            <div class="uc-header">
              <div class="uc-avatar" id="userAvatar">U</div>
              <div class="uc-ident">
                <div class="uc-name" id="userNameLarge">User</div>
                <div class="uc-points" id="userPoints">0 Points</div>
              </div>
            </div>

            <div class="uc-items">
              <a href="profile.html" class="uc-item"><i class='bx bx-id-card'></i> Profile</a>
              <a href="orders.html" class="uc-item"><i class='bx bx-package'></i> Orders</a>
              <a href="tickets.html" class="uc-item"><i class='bx bx-support'></i> Need Help?</a>
            </div>

            <button class="uc-item uc-logout" id="logoutBtn"><i class='bx bx-log-out'></i> Logout</button>
          </div>
        </div>

        <a href="cart.html" class="icon-btn cart" aria-label="Cart">
          <i class='bx bx-cart'></i><span class="count" id="cartCount">0</span>
        </a>
      </div>
    </div>

    <!-- Global nav -->
    <nav class="mainnav" aria-label="Main navigation">
      <ul>
        <li><a href="landing.html">HOME</a></li>
        <li class="has-sub">
          <button class="nav-link">CONSOLES <i class='bx bx-chevron-down'></i></button>
          <ul class="submenu">
            <li><a href="#">PS</a></li>
            <li><a href="#">Xbox</a></li>
            <li><a href="#">Nintendo</a></li>
          </ul>
        </li>
        <li class="has-sub">
          <button class="nav-link">GAMES<i class='bx bx-chevron-down'></i></button>
          <ul class="submenu">
            <li><a href="#">PS5</a></li>
            <li><a href="#">PS4</a></li>
            <li><a href="games.html">Xbox</a></li>
            <li><a href="#">Nintendo</a></li>
          </ul>
        </li>
        <li class="has-sub">
          <button class="nav-link">GAMING PERIPHERALS <i class='bx bx-chevron-down'></i></button>
          <ul class="submenu">
            <li><a href="#">Keyboards</a></li>
            <li><a href="#">Mice</a></li>
            <li><a href="#">Monitors</a></li>
          </ul>
        </li>
        <li class="has-sub">
          <button class="nav-link">TOYS & COLLECTIBLES <i class='bx bx-chevron-down'></i></button>
          <ul class="submenu">
            <li><a href="#">Figures</a></li>
            <li><a href="#">Limited Editions</a></li>
          </ul>
        </li>
        <li class="has-sub">
          <button class="nav-link">LIFE STYLE & MERCHANDISE <i class='bx bx-chevron-down'></i></button>
          <ul class="submenu">
            <li><a href="#">Apparel</a></li>
            <li><a href="#">Bags</a></li>
            <li><a href="#">Posters</a></li>
          </ul>
        </li>
      </ul>
    </nav>
  </header>

  <main class="wrapper">
    <section class="cart-page">
      <h2>Shopping Cart</h2>

      <div class="cart-header">
        <span>Item</span>
        <span></span>
        <span>Quantity</span>
        <span>Price</span>
        <span>Amount</span>
        <span></span>
      </div>

      <div class="cart-container" id="cartContainer">
        <p class="empty">Loading your cart...</p>
      </div>

      <div class="cart-summary" id="cartSummary">
  <p>Total: <span id="cartTotal">RM 0.00</span></p>
  <a href="checkout.html" class="checkout-btn">Checkout →</a>
</div>

    </section>
  </main>

  <!-- === Firebase Auth + Cart === -->
  <script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
  import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
  import { getFirestore, collection, getDocs, doc, deleteDoc, updateDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyCnIL_Lg-sEQs-52YRUL9PTaWTWc4Xu5xA",
    authDomain: "final-year-b1cc2.firebaseapp.com",
    projectId: "final-year-b1cc2",
    storageBucket: "final-year-b1cc2.firebasestorage.app",
    messagingSenderId: "537245015385",
    appId: "1:537245015385:web:ab79c9ec5e2a74cc924048"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);

  const cartContainer = document.getElementById("cartContainer");
  const cartTotalEl = document.getElementById("cartTotal");
  const cartCountEl = document.getElementById("cartCount");

  const userMenu = document.getElementById("userMenu");
  const loginBtn = document.getElementById("loginBtn");
  const userBtn = document.getElementById("userBtn");
  const logoutBtn = document.getElementById("logoutBtn");
  const userNameLarge = document.getElementById("userNameLarge");
  const userAvatar = document.getElementById("userAvatar");
  const userDropdown = document.getElementById("userDropdown");

  const formatCurrency = (num) => `RM ${num.toFixed(2)}`;

  // === Render Cart ===
  async function renderCart(uid) {
    const cartRef = collection(db, "users", uid, "cart");
    const snap = await getDocs(cartRef);
    if (snap.empty) {
      cartContainer.innerHTML = `<p class="empty">Your cart is empty.</p>`;
      cartTotalEl.textContent = "RM 0.00";
      cartCountEl.textContent = "0";
      return;
    }

    let total = 0;
    let itemCount = 0;
    cartContainer.innerHTML = "";
    snap.forEach(docSnap => {
      const item = docSnap.data();
      const itemTotal = item.price * item.quantity;
      total += itemTotal;
      itemCount += item.quantity;

      const div = document.createElement("div");
      div.className = "cart-item";
      div.innerHTML = `
        <div class="thumb"><img src="${item.image || 'Images/placeholder.jpg'}" alt="${item.title}"></div>
        <div class="item-name">${item.title}</div>
        <div class="item-qty">
          <button class="qty-btn minus">−</button>
          <span class="qty">${item.quantity}</span>
          <button class="qty-btn plus">+</button>
        </div>
        <div class="item-price">${formatCurrency(item.price)}</div>
        <div class="item-total">${formatCurrency(itemTotal)}</div>
        <button class="remove-btn"><i class='bx bx-x-circle'></i></button>
      `;

      div.querySelector(".plus").addEventListener("click", async () => {
        await updateDoc(doc(db, "users", uid, "cart", docSnap.id), { quantity: item.quantity + 1 });
        renderCart(uid);
      });
      div.querySelector(".minus").addEventListener("click", async () => {
        if (item.quantity > 1) {
          await updateDoc(doc(db, "users", uid, "cart", docSnap.id), { quantity: item.quantity - 1 });
        } else {
          await deleteDoc(doc(db, "users", uid, "cart", docSnap.id));
        }
        renderCart(uid);
      });
      div.querySelector(".remove-btn").addEventListener("click", async () => {
        await deleteDoc(doc(db, "users", uid, "cart", docSnap.id));
        renderCart(uid);
      });

      cartContainer.appendChild(div);
    });

    cartTotalEl.textContent = formatCurrency(total);
    cartCountEl.textContent = itemCount;
  }

  // === Handle Auth State ===
 onAuthStateChanged(auth, (user) => {
  if (user) {
    // Show user UI
    loginBtn.style.display = "none";
    userMenu.style.display = "inline-block";

    const displayName = user.displayName || user.email.split("@")[0];
    const initials = displayName.charAt(0).toUpperCase();

    userNameLarge.textContent = displayName;
    userAvatar.textContent = initials;

    // Show cart bubble
    cartCountEl.style.display = "inline-block";

    // Render Cart
    renderCart(user.uid);
  } else {
    // Hide user info
    userMenu.style.display = "none";
    loginBtn.style.display = "inline-flex";
    cartContainer.innerHTML = `<p>Please log in to view your cart.</p>`;
    cartCountEl.textContent = "0";
    cartCountEl.style.display = "none"; // 👈 Hide bubble completely when logged out
  }
});


  // === Logout Button ===
  logoutBtn.addEventListener("click", async () => {
    await signOut(auth);
    window.location.href = "landing.html";
  });

  // === Toggle user dropdown ===
  userBtn.addEventListener("click", () => {
    userMenu.classList.toggle("open");
  });

  // Close dropdown on click outside
  window.addEventListener("click", (e) => {
    if (!userMenu.contains(e.target)) {
      userMenu.classList.remove("open");
    }
  });
</script>

</body>
</html>
