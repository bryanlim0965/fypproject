<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Game Store | Checkout</title>

  <!-- Fonts + Icons -->
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet"/>
  <link href="https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css" rel="stylesheet"/>
  <link rel="stylesheet" href="landing.css" />

  <style>
  body {
    background-color: #0b0b0b;
    color: #fff;
    font-family: 'Poppins', sans-serif;
  }

  h2 {
    text-align: center;
    color: #00ff80;
    font-weight: 600;
    margin-top: 30px;
    margin-bottom: 15px;
  }

  .checkout-container {
    display: grid;
    grid-template-columns: 2fr 1fr;
    gap: 2rem;
    max-width: 1200px;
    margin: 0 auto;
    background: #111;
    border-radius: 16px;
    padding: 2rem;
    box-shadow: 0 0 25px rgba(0, 255, 100, 0.05);
    overflow: hidden;
  }

  .checkout-left {
    display: flex;
    flex-direction: column;
    gap: 1.5rem;
    overflow-y: auto;
    max-height: 80vh;
    padding-right: 1rem;
  }

  .checkout-right {
    position: sticky;
    top: 0rem;
    height: fit-content;
    align-self: start;
    display: flex;
    flex-direction: column;
    gap: 1.5rem;
  }

  @media (max-width: 850px) {
    .checkout-container {
      grid-template-columns: 1fr;
    }
    .checkout-left {
      max-height: none;
      overflow: visible;
    }
    .checkout-right {
      position: relative;
      top: 0;
    }
  }

  h3 {
    color: #00ff80;
    font-size: 1.1rem;
    margin-bottom: 0.5rem;
  }

  .checkout-section {
    background: #1a1a1a;
    border: 1px solid #222;
    border-radius: 12px;
    padding: 1.2rem;
  }

  .cart-item {
    display: grid;
    grid-template-columns: 70px 2fr 1fr 1fr;
    align-items: center;
    gap: 0.5rem;
    border-bottom: 1px solid #222;
    padding: 0.5rem 0;
  }

  .cart-item:last-child { border-bottom: none; }

  .cart-item img {
    width: 60px;
    height: 60px;
    object-fit: cover;
    border-radius: 8px;
  }

  .cart-item span {
    color: #00ff80;
    font-weight: 600;
  }

  input, select, textarea {
    width: 100%;
    padding: 0.8rem;
    margin-top: 0.4rem;
    border-radius: 10px;
    border: 1px solid #222;
    background: rgba(255, 255, 255, 0.856);
    color: #fff;
  }

  .readonly { background: #222; }

  /* Make readonly-like sections */
  .checkout-section.readonly-style {
    background: #222;
    border: 1px solid #333;
    color: white;
  }

  .checkout-section.readonly-style h3 {
    color: white;
  }

  .checkout-section.readonly-style select,
  .checkout-section.readonly-style textarea {
    background: #222;
    border: 1px solid #333;
    color: white;
  }

  .checkout-btn, .apply-btn {
    background: #00ff80;
    border: none;
    color: #111;
    font-weight: 600;
    padding: 0.9rem;
    border-radius: 10px;
    cursor: pointer;
    transition: background 0.2s ease;
    text-align: center;
  }

  .checkout-btn:hover, .apply-btn:hover { background: #00e070; }

  .price-box {
    background: #1a1a1a;
    border: 1px solid #222;
    border-radius: 12px;
    padding: 1.2rem;
  }

  .price-row {
    display: flex;
    justify-content: space-between;
    margin-bottom: 0.6rem;
    font-weight: 600;
  }

  .points-info {
    color: #b0ffb0;
    font-size: 0.9rem;
    margin-top: 0.5rem;
  }

  ul { list-style: none; padding-left: 1rem; }
  ul li { line-height: 1.6; }

  /* Scrollbar */
  .checkout-left::-webkit-scrollbar { width: 10px; }
  .checkout-left::-webkit-scrollbar-track { background: #0b0b0b; border-radius: 10px; }
  .checkout-left::-webkit-scrollbar-thumb {
    background-color: #00ff80;
    border-radius: 10px;
    border: 2px solid #0b0b0b;
  }
  .checkout-left::-webkit-scrollbar-thumb:hover { background-color: #00e070; }
  .checkout-left { scrollbar-width: thin; scrollbar-color: #00ff80 #0b0b0b; }
  </style>
</head>
<body>
  <main>
    <h2>Checkout</h2>
    <div class="checkout-container">
      <!-- LEFT SIDE -->
      <div class="checkout-left">

        <!-- Shipping Info -->
        <div class="checkout-section">
          <h3>Shipping Information</h3>
          <input type="text" id="fullName" placeholder="Full Name" class="readonly" readonly>
          <input type="email" id="email" placeholder="Email" class="readonly" readonly>
          <input type="text" id="phone" placeholder="Phone" class="readonly" readonly>

          <input type="text" id="address1" placeholder="Address Line 1" readonly style="background: #222; color: #fff; border: 1px solid #222; border-radius: 10px; padding: 0.8rem;">
          <select id="city" readonly style="background: #222; color: #fff; border: 1px solid #222; border-radius: 10px; padding: 0.8rem;">
  <option value="">Select State</option>
  <option value="Johor">Johor</option>
  <option value="Kedah">Kedah</option>
  <option value="Kelantan">Kelantan</option>
  <option value="Melaka">Melaka</option>
  <option value="Negeri Sembilan">Negeri Sembilan</option>
  <option value="Pahang">Pahang</option>
  <option value="Perak">Perak</option>
  <option value="Perlis">Perlis</option>
  <option value="Pulau Pinang">Penang</option>
  <option value="Sabah">Sabah</option>
  <option value="Sarawak">Sarawak</option>
  <option value="Selangor">Selangor</option>
  <option value="Terengganu">Terengganu</option>
</select>

          <input type="text" id="postcode" placeholder="Postcode" readonly style="background: #222; color: #fff; border: 1px solid #222; border-radius: 10px; padding: 0.8rem;">

          <input type="text" id="country" value="Malaysia" class="readonly" readonly>
          <button id="editAddressBtn" class="apply-btn" style="margin-top: 10px;">Edit</button>
        </div>

        <!-- Delivery Options -->
        <div class="checkout-section readonly-style">
          <h3>Delivery Options</h3>
          <select id="deliveryOption">
            <option value="self">Self Pickup (Free)</option>
            <option value="shipping">Shipping (+RM5)</option>
          </select>
        </div>

        <!-- Payment -->
        <div class="checkout-section readonly-style">
          <h3>Payment</h3>
          <p>Transfer payment to:</p>
          <ul>
            <li>Bank: 1234567890</li>
            <li>TNG: 0987654321</li>
          </ul>
          <input type="file" id="paymentReceipt" accept="image/*" style="background: rgba(255, 255, 255, 0.856); color: #000; border-radius: 10px; padding: 0.8rem; border: 1px solid #222;">
        </div>

        <!-- Remarks -->
        <div class="checkout-section readonly-style">
          <h3>Order Remarks</h3>
          <textarea id="orderRemarks" rows="3" placeholder="Special instructions..."></textarea>
        </div>

      </div>

      <!-- RIGHT SIDE -->
      <div class="checkout-right">
        <div class="checkout-section">
          <h3>Order Summary</h3>
          <div id="checkoutCartContainer">
            <p>Loading your cart...</p>
          </div>
        </div>

        <!-- Promo Code -->
        <div class="checkout-section">
          <h3>Promo Code</h3>
          <input type="text" id="promoCode" placeholder="Enter promo code">
          <button class="apply-btn" id="applyPromoBtn">Apply</button>
          <p id="promoMessage" class="points-info"></p>
        </div>

        <div class="price-box">
          <div class="price-row"><span>Subtotal:</span><span id="subtotal">RM 0.00</span></div>
          <div class="price-row"><span>Delivery:</span><span id="deliveryFee">RM 0.00</span></div>
          <div class="price-row"><span>Discount:</span><span id="discountTotal">RM 0.00</span></div>
          <div class="price-row" style="font-size:1.2rem; color:#00ff80;">
            <span>Total:</span><span id="grandTotal">RM 0.00</span>
          </div>
          <p class="points-info" id="pointsInfo">Points to earn: 0</p>
          <button class="checkout-btn" id="placeOrderBtn">Place Order →</button>
        </div>
      </div>
    </div>
  </main>

  <script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
  import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
  import { 
  getFirestore, collection, getDocs, doc, setDoc, getDoc, deleteDoc, serverTimestamp 
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";


  const firebaseConfig = {
    apiKey: "AIzaSyCnIL_Lg-sEQs-52YRUL9PTaWTWc4Xu5xA",
    authDomain: "final-year-b1cc2.firebaseapp.com",
    projectId: "final-year-b1cc2",
    storageBucket: "final-year-b1cc2.firebasestorage.app",
    messagingSenderId: "537245015385",
    appId: "1:537245015385:web:ab79c9ec5e2a74cc924048"
  };
  const CLOUDINARY_URL = "https://api.cloudinary.com/v1_1/dqgvby5lb/image/upload";
const CLOUDINARY_PRESET = "payment_receipts";


  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);

  // === DOM elements ===
  const checkoutCartContainer = document.getElementById("checkoutCartContainer");
  const subtotalEl = document.getElementById("subtotal");
  const deliveryFeeEl = document.getElementById("deliveryFee");
  const discountTotalEl = document.getElementById("discountTotal");
  const grandTotalEl = document.getElementById("grandTotal");
  const pointsInfo = document.getElementById("pointsInfo");
  const promoCodeInput = document.getElementById("promoCode");
  const applyPromoBtn = document.getElementById("applyPromoBtn");
  const promoMessage = document.getElementById("promoMessage");
  const deliveryOption = document.getElementById("deliveryOption");
  const paymentReceipt = document.getElementById("paymentReceipt");
  const placeOrderBtn = document.getElementById("placeOrderBtn");

  const address1El = document.getElementById("address1");
  const cityEl = document.getElementById("city");
  const postcodeEl = document.getElementById("postcode");
  const editAddressBtn = document.getElementById("editAddressBtn");

  let cartItems = [];
  let subtotal = 0, discount = 0, deliveryFee = 0, grandTotal = 0, pointsEarned = 0;
  let currentUser = null;
  const formatCurrency = (n) => `RM ${n.toFixed(2)}`;

  // === Address edit toggle ===
  let isEditing = false;
  editAddressBtn.addEventListener("click", async () => {
    if (!currentUser) return alert("Please log in first.");

    isEditing = !isEditing;
    editAddressBtn.textContent = isEditing ? "Save" : "Edit";

    const editableFields = [address1El, cityEl, postcodeEl];
    editableFields.forEach(f => {
      f.readOnly = !isEditing;
      if (f.tagName === "SELECT") f.disabled = !isEditing;
      f.style.background = isEditing ? "#fff" : "#222";
      f.style.color = isEditing ? "#000" : "#fff";
    });

    if (!isEditing) {
      // Save updated info to Firestore
      const userDocRef = doc(db, "users", currentUser.uid, "profile", "shippingInfo");
      await setDoc(userDocRef, {
        address1: address1El.value,
        city: cityEl.value,
        postcode: postcodeEl.value,
        country: "Malaysia"
      }, { merge: true });
      alert("Shipping info updated successfully!");
    }
  });

  // === Load shipping info from Firestore ===
  async function loadShippingInfo(uid) {
    const ref = doc(db, "users", uid, "profile", "shippingInfo");
    const snap = await getDoc(ref);
    if (snap.exists()) {
      const data = snap.data();
      address1El.value = data.address1 || "";
      cityEl.value = data.city || "";
      postcodeEl.value = data.postcode || "";
      document.getElementById("country").value = data.country || "Malaysia";
    }
  }

  // === Load cart ===
  async function renderCart(uid) {
    const cartRef = collection(db, "users", uid, "cart");
    const snap = await getDocs(cartRef);
    cartItems = [];
    subtotal = 0;
    checkoutCartContainer.innerHTML = "";

    if (snap.empty) {
      checkoutCartContainer.innerHTML = "<p>Your cart is empty.</p>";
      return;
    }

    snap.forEach(docSnap => {
      const item = docSnap.data();
      item.id = docSnap.id;
      cartItems.push(item);
      const itemTotal = item.price * item.quantity;
      subtotal += itemTotal;

      const div = document.createElement("div");
      div.className = "cart-item";
      div.innerHTML = `
        <img src="${item.image || 'Images/placeholder.jpg'}" alt="${item.title}">
        <span>${item.title}</span>
        <span>x${item.quantity}</span>
        <span>${formatCurrency(itemTotal)}</span>
      `;
      checkoutCartContainer.appendChild(div);
    });

    updateTotals();
  }

  function updateTotals() {
    deliveryFee = deliveryOption.value === "shipping" ? 5 : 0;
    grandTotal = subtotal + deliveryFee - discount;
    pointsEarned = Math.floor(subtotal);

    subtotalEl.textContent = formatCurrency(subtotal);
    deliveryFeeEl.textContent = formatCurrency(deliveryFee);
    discountTotalEl.textContent = formatCurrency(discount);
    grandTotalEl.textContent = formatCurrency(grandTotal);
    pointsInfo.textContent = `Points to earn: ${pointsEarned}`;
  }

  deliveryOption.addEventListener("change", updateTotals);

  applyPromoBtn.addEventListener("click", () => {
    const code = promoCodeInput.value.trim().toUpperCase();
    if (code === "DISCOUNT10") {
      discount = 10;
      promoMessage.textContent = "Promo applied! RM10 off.";
    } else {
      discount = 0;
      promoMessage.textContent = "Invalid promo code.";
    }
    updateTotals();
  });

  // === Auth listener ===
  onAuthStateChanged(auth, async (user) => {
    if (user) {
      currentUser = user;
      document.getElementById("fullName").value = user.displayName || user.email.split("@")[0];
      document.getElementById("email").value = user.email;
      document.getElementById("phone").value = user.phoneNumber || "";
      await loadShippingInfo(user.uid);
      await renderCart(user.uid);
    } else {
      checkoutCartContainer.innerHTML = "<p>Please log in to continue.</p>";
      placeOrderBtn.disabled = true;
    }
  });


// === Place order ===
placeOrderBtn.addEventListener("click", async () => {
  if (!currentUser) return alert("Please log in first.");
  if (cartItems.length === 0) return alert("Your cart is empty.");
  if (paymentReceipt.files.length === 0) return alert("Please upload your payment receipt.");

  try {
    // ✅ 1. Upload receipt image to Cloudinary
    const file = paymentReceipt.files[0];
    const formData = new FormData();
    formData.append("file", file);
    formData.append("upload_preset", CLOUDINARY_PRESET);

    const cloudRes = await fetch(CLOUDINARY_URL, { method: "POST", body: formData });
    const cloudData = await cloudRes.json();

    if (!cloudData.secure_url) {
      console.error("Cloudinary upload error:", cloudData);
      return alert("❌ Upload failed. Please try again.");
    }

    const receiptURL = cloudData.secure_url;

    // ✅ 2. Get user's address (ensure filled)
    let addressData = {
      address1: address1El.value || "-",
      city: cityEl.value || "-",
      postcode: postcodeEl.value || "-",
      country: "Malaysia"
    };

    // ✅ 3. Prepare order data
    const orderData = {
      uid: currentUser.uid,
      items: cartItems,
      subtotal,
      discount,
      deliveryFee,
      total: grandTotal,
      pointsEarned,
      deliveryOption: deliveryOption.value,
      remarks: document.getElementById("orderRemarks").value,
      address: addressData,
      paymentReceiptName: receiptURL, // ✅ now stores Cloudinary URL
      createdAt: serverTimestamp(),
      status: "pending"
    };

    // ✅ 4. Save to Firestore
    const orderRef = doc(collection(db, "users", currentUser.uid, "orders"));
    await setDoc(orderRef, orderData);

    // ✅ 5. Clear cart
    for (const item of cartItems) {
      await deleteDoc(doc(db, "users", currentUser.uid, "cart", item.id));
    }

    alert("✅ Order placed successfully!");
    window.location.href = "order-confirmation.html";
  } catch (err) {
    console.error("Place order error:", err);
    alert("❌ Something went wrong. Check console for details.");
  }
});


</script>

</body>
</html>
